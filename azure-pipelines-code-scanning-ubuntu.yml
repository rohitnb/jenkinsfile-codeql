name: Code Scanning on Azure Pipelines

trigger:
- master

pool:
  vmImage: ubuntu-latest

variables:
  buildConfiguration: 'Release'

steps:
- script: |
   # Download the CodeQL Linux Runner
   wget https://github.com/github/codeql-action/releases/download/codeql-bundle-20210319/codeql-runner-linux
   mv codeql-runner-linux ../
   chmod +x ../codeql-runner-linux
  displayName: 'Get latest CodeQL package. Install on Agent.'

- script: |
   GITHUB_HOST="https://`echo $(Build.Repository.Uri) | cut -d'/' -f3`"
   # Run CodeQL Initialization
   ../codeql-runner-linux init \
    --repository $(Build.Repository.Name) \
    --github-url $GITHUB_HOST \
    --github-auth $(GITHUB_PAT) \
    --temp-dir ../codeql-runner
  displayName: 'Initialize CodeQL Executable and create a CodeQL database'  

- script: |
   GITHUB_HOST="https://`echo $(Build.Repository.Uri) | cut -d'/' -f3`" 
   #echo "======================Exporting Envt variables======================"
   #. ../codeql-runner/codeql-runner/codeql-env.sh
   #echo "======================Building the Project======================"
   #../codeql-runner-linux autobuild --temp-dir ../codeql-runner
   # Run your custom build commands instead if autobuild fails
   echo "======================Run CodeQL Analyze======================" 
   ../codeql-runner-linux analyze \
      --repository $(Build.Repository.Name) \
      --github-url  $GITHUB_HOST \
      --github-auth $(GITHUB_PAT) \
      --commit $(Build.SourceVersion) \
      --ref $(Build.SourceBranch) \
      --temp-dir ../codeql-runner
  displayName: 'Build and Analyze'
